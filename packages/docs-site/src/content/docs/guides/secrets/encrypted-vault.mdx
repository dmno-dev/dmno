---
title: DMNO Encrypted Vaults
---

:::caution
THIS NEEDS TO BE UPDATED
:::

## Creating a New Vault 

Install the package
`pnpm i @dmno/encrypted-vault-plugin`
- in the root if going to be shared, or in specific service(s) if not

-----

Initialize the plugin in the root (or service if not shared)

add explanation about plugin naming, give example of `vault/prod`, `vault/dev`
probably also want an explanation of why/when you'd want to split into multiple vaults

```typescript
import { EncryptedVaultDmnoPlugin, EncryptedVaultTypes } from '@dmno/encrypted-vault-plugin';

const MyVault = new EncryptedVaultDmnoPlugin('vault', {
  key: configPath('DMNO_VAULT_KEY'),
});


export default defineWorkspaceConfig({
  schema: {
    DMNO_VAULT_KEY: {
      extends: EncryptedVaultTypes.encryptionKey,
      // NOTE - the type itself is already marked as secret
    },
  }
```

If initializing in root and you need to use in a child service, inject the already configured plugin

```typescript
import { EncryptedVaultDmnoPlugin } from '@dmno/encrypted-vault-plugin';

const MyVault = EncryptedVaultDmnoPlugin.injectInstance('vault'); // same "instance name" it was created with
```

-----

Initialize the vault / key

- `pnpm exec dmno plugin -p vault -- setup`
- `pnpm exec dmno plugin`
  (can do interactively...)

- detects if vault is configured but has no key value
- detect if vault file is empty/exists
  - create new key (spits into .env.local? or just outputs to console?)
  - push to request flow if vault is not empty


-----

start adding vault items to your schema
```typescript
{
  // simple case example
  SUPER_SECRET_ITEM: {
    value: MyVault.item(),
  },
  // complex example - multiple-vaults w/ toggle
  ITEM_WITH_PROD_ONLY_SECRET: {
    value: toggleByNodeEnv({
      _default: 'not-a-secret',
      staging: NonProdVault.item(),
      production: ProdVault.item(),
    })
  },
}
```

----
Fill your vault with secrets

Add encrypted values to the vault
- `pnpm exec dmno plugin -p vault -- set-item -s root -k VAULT_TEST` (upsert?)
   enter the value

- `pnpm exec dmno plugin -p vault -- set-item`
  - browse/select through the items that are using .item in the schema
  - shows which are empty / full
  - enter the value

- shortcut to fill many items at once
  - `pnpm exec dmno plugin -p vault -- set-item --from-env[=insert-only]`


-----

- `pnpm exec dmno plugin -p vault -- rotate-key`
- generates new key, spits it out (into .env.local?)
- re-encrypts all the values, 




-----------------------

## Accessing an Existing Vault

pull down the repo

dmno dev / or load / whatverer

Hey your vault plugin is failing
- needs a key

This key already exists, you need to get it from whoever set it up.
- `pnpm exec dmno plugin -s vault -- create-key-request`

We've generated a encryption keypair to facilitate a secure key exchange, send this to your coworker who has the key
> `pnpm exec dmno plugin -s vault -- respond-key-request ALKJDFKLSJDFLKJDSFLKSJDFLKSJDFLKDJF`

paste this back to whoever created the request
> `pnpm exec dmno plugin -s vault -- receive-key LKFJLE:WQKNRJ:KLMWENR:KMWENF:KLSDNF:KLJMNSD`


------

you will need to set this key env var on whatever external platforms you are using (ci/deployments/etc)
